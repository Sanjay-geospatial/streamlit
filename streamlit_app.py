import streamlit as st
import tensorflow as tf
import os
import requests
import gdown
import rioxarray as rxr


GOOGLE_DRIVE_URL = "https://drive.google.com/uc?id=1dwRQJytS7qidRt4bhGYz2MDKBlzn8XCQ"
MODEL_PATH = "cloud_removal_model.h5"

@st.cache_resource
def download_and_load_model():
    if not os.path.exists(MODEL_PATH) or os.path.getsize(MODEL_PATH) < 100000:  # 100KB sanity check
        st.write("Downloading model...")
        gdown.download(GOOGLE_DRIVE_URL, MODEL_PATH, quiet=False, use_cookies=True)

    # extra check for corruption
    if os.path.getsize(MODEL_PATH) < 100000:  # definitely too small
        raise OSError("Downloaded model is too small or incomplete.")

    return tf.keras.models.load_model(MODEL_PATH)

model = download_and_load_model()
model = download_and_load_model()

# Utility: preprocess input image
def preprocess_image(img):
    img = normalized_cloud_free = 2 * (np.array(img) - np.array(img).min()) / (np.array(img).max() - np.array(img).min()) - 1
    img = np.expand_dims(img, axis = 0)
    return img

# Utility: postprocess output image
def postprocess_image(pred):
    pred = ((pred + 1) / 2)**0.4
    return pred

# Streamlit UI
st.title("â˜ï¸â†’ðŸŒ¤ï¸ Cloud Removal App")
st.write("Upload a cloudy satellite image to see a cloud-free version generated by the model.")

uploaded_file = st.file_uploader("Upload Cloudy Image", type=["jpg", "jpeg", "png", "tif", "tiff"])

if uploaded_file:
    input_image = rxr.open_rasterio(uploaded_file)
    st.image(input_image, caption="Input: Cloudy Image", use_column_width=True)

    with st.spinner("Generating cloud-free image..."):
        input_tensor = preprocess_image(input_image)
        output_tensor = model.predict(input_tensor)
        output_image = postprocess_image(output_tensor)

    st.image(output_image, caption="Output: Cloud-Free Image", use_column_width=True)




